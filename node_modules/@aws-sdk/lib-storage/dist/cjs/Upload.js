"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Upload = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const events_1 = require("events");
const chunker_1 = require("./chunker");
const bytelength_1 = require("./bytelength");
const abort_controller_1 = require("@aws-sdk/abort-controller");
const MIN_PART_SIZE = 1024 * 1024 * 5;
class Upload extends events_1.EventEmitter {
    constructor(options) {
        super();
        /**
         * S3 multipart upload does not allow more than 10000 parts.
         */
        this.MAX_PARTS = 10000;
        // Defaults.
        this.queueSize = 4;
        this.partSize = MIN_PART_SIZE;
        this.leavePartsOnError = false;
        this.tags = [];
        this.concurrentUploaders = [];
        this.uploadedParts = [];
        this.isMultiPart = true;
        // set defaults from options.
        this.queueSize = options.queueSize || this.queueSize;
        this.partSize = options.partSize || this.partSize;
        this.leavePartsOnError = options.leavePartsOnError || this.leavePartsOnError;
        this.tags = options.tags || this.tags;
        this.client = options.client;
        this.params = options.params;
        this.__validateInput();
        // set progress defaults
        this.totalBytes = bytelength_1.byteLength(this.params.Body);
        this.bytesUploadedSoFar = 0;
        this.abortController = new abort_controller_1.AbortController();
    }
    async abort() {
        /**
         * Abort stops all new uploads and immediately exists the top level promise on this.done()
         * Concurrent threads in flight clean up eventually.
         */
        this.abortController.abort();
    }
    async done() {
        return await Promise.race([this.__doMultipartUpload(), this.__abortTimeout(this.abortController.signal)]);
    }
    on(event, listener) {
        this.uploadEvent = event;
        super.on(event, listener);
    }
    async __uploadUsingPut(dataPart) {
        this.isMultiPart = false;
        const params = { ...this.params, Body: dataPart.data };
        const putResult = await this.client.send(new client_s3_1.PutObjectCommand(params));
        this.putResponse = putResult;
        const totalSize = bytelength_1.byteLength(dataPart.data);
        this.__notifyProgress({
            loaded: totalSize,
            total: totalSize,
            part: 1,
            Key: this.params.Key,
            Bucket: this.params.Bucket,
        });
    }
    async __createMultipartUpload() {
        if (!this.createMultiPartPromise) {
            const createCommandParams = { ...this.params, Body: undefined };
            this.createMultiPartPromise = this.client.send(new client_s3_1.CreateMultipartUploadCommand(createCommandParams));
        }
        const createMultipartUploadResult = await this.createMultiPartPromise;
        this.uploadId = createMultipartUploadResult.UploadId;
    }
    async __doConcurrentUpload(dataFeeder) {
        for await (const dataPart of dataFeeder) {
            if (this.uploadedParts.length > this.MAX_PARTS) {
                throw new Error(`Exceeded ${this.MAX_PARTS} as part of the upload to ${this.params.Key} and ${this.params.Bucket}.`);
            }
            try {
                if (this.abortController.signal.aborted) {
                    return;
                }
                // Use put instead of multi-part for one chunk uploads.
                if (dataPart.partNumber === 1 && dataPart.lastPart) {
                    return await this.__uploadUsingPut(dataPart);
                }
                if (!this.uploadId) {
                    await this.__createMultipartUpload();
                    if (this.abortController.signal.aborted) {
                        return;
                    }
                }
                const partResult = await this.client.send(new client_s3_1.UploadPartCommand({
                    ...this.params,
                    UploadId: this.uploadId,
                    Body: dataPart.data,
                    PartNumber: dataPart.partNumber,
                }));
                if (this.abortController.signal.aborted) {
                    return;
                }
                this.uploadedParts.push({
                    PartNumber: dataPart.partNumber,
                    ETag: partResult.ETag,
                });
                this.bytesUploadedSoFar += bytelength_1.byteLength(dataPart.data);
                this.__notifyProgress({
                    loaded: this.bytesUploadedSoFar,
                    total: this.totalBytes,
                    part: dataPart.partNumber,
                    Key: this.params.Key,
                    Bucket: this.params.Bucket,
                });
            }
            catch (e) {
                // Failed to create multi-part or put
                if (!this.uploadId) {
                    throw e;
                }
                // on leavePartsOnError throw an error so users can deal with it themselves,
                // otherwise swallow the error.
                if (this.leavePartsOnError) {
                    throw e;
                }
            }
        }
    }
    async __doMultipartUpload() {
        // Set up data input chunks.
        const dataFeeder = chunker_1.getChunk(this.params.Body, this.partSize);
        // Create and start concurrent uploads.
        for (let index = 0; index < this.queueSize; index++) {
            const currentUpload = this.__doConcurrentUpload(dataFeeder);
            this.concurrentUploaders.push(currentUpload);
        }
        // Create and start concurrent uploads.
        await Promise.all(this.concurrentUploaders);
        if (this.abortController.signal.aborted) {
            throw Object.assign(new Error("Upload aborted."), { name: "AbortError" });
        }
        let result;
        if (this.isMultiPart) {
            this.uploadedParts.sort((a, b) => a.PartNumber - b.PartNumber);
            const uploadCompleteParams = {
                ...this.params,
                Body: undefined,
                UploadId: this.uploadId,
                MultipartUpload: {
                    Parts: this.uploadedParts,
                },
            };
            result = await this.client.send(new client_s3_1.CompleteMultipartUploadCommand(uploadCompleteParams));
        }
        else {
            result = this.putResponse;
        }
        // Add tags to the object after it's completed the upload.
        if (this.tags.length) {
            await this.client.send(new client_s3_1.PutObjectTaggingCommand({
                ...this.params,
                Tagging: {
                    TagSet: this.tags,
                },
            }));
        }
        return result;
    }
    __notifyProgress(progress) {
        if (this.uploadEvent) {
            this.emit(this.uploadEvent, progress);
        }
    }
    async __abortTimeout(abortSignal) {
        return new Promise((resolve, reject) => {
            abortSignal.onabort = () => {
                const abortError = new Error("Upload aborted.");
                abortError.name = "AbortError";
                reject(abortError);
            };
        });
    }
    __validateInput() {
        if (!this.params) {
            throw new Error(`InputError: Upload requires params to be passed to upload.`);
        }
        if (!this.client) {
            throw new Error(`InputError: Upload requires a AWS client to do uploads with.`);
        }
        if (this.partSize < MIN_PART_SIZE) {
            throw new Error(`EntityTooSmall: Your proposed upload partsize [${this.partSize}] is smaller than the minimum allowed size [${MIN_PART_SIZE}] (5MB)`);
        }
        if (this.queueSize < 1) {
            throw new Error(`Queue size: Must have at least one uploading queue.`);
        }
    }
}
exports.Upload = Upload;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXBsb2FkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL1VwbG9hZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxrREFZNEI7QUFDNUIsbUNBQXNDO0FBRXRDLHVDQUFxQztBQUNyQyw2Q0FBMEM7QUFDMUMsZ0VBQXlFO0FBUXpFLE1BQU0sYUFBYSxHQUFHLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDO0FBRXRDLE1BQWEsTUFBTyxTQUFRLHFCQUFZO0lBK0J0QyxZQUFZLE9BQWdCO1FBQzFCLEtBQUssRUFBRSxDQUFDO1FBL0JWOztXQUVHO1FBQ0ssY0FBUyxHQUFHLEtBQUssQ0FBQztRQUUxQixZQUFZO1FBQ0osY0FBUyxHQUFHLENBQUMsQ0FBQztRQUNkLGFBQVEsR0FBRyxhQUFhLENBQUM7UUFDekIsc0JBQWlCLEdBQUcsS0FBSyxDQUFDO1FBQzFCLFNBQUksR0FBVSxFQUFFLENBQUM7UUFXakIsd0JBQW1CLEdBQW9CLEVBQUUsQ0FBQztRQUcxQyxrQkFBYSxHQUFvQixFQUFFLENBQUM7UUFJcEMsZ0JBQVcsR0FBWSxJQUFJLENBQUM7UUFNbEMsNkJBQTZCO1FBQzdCLElBQUksQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3JELElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ2xELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxPQUFPLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDO1FBQzdFLElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDO1FBRXRDLElBQUksQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUM3QixJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7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QUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLFdBQVcsQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFO2dCQUN6QixNQUFNLFVBQVUsR0FBRyxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2dCQUNoRCxVQUFVLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQztnQkFDL0IsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3JCLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGVBQWU7UUFDYixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNoQixNQUFNLElBQUksS0FBSyxDQUFDLDREQUE0RCxDQUFDLENBQUM7U0FDL0U7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNoQixNQUFNLElBQUksS0FBSyxDQUFDLDhEQUE4RCxDQUFDLENBQUM7U0FDakY7UUFFRCxJQUFJLElBQUksQ0FBQyxRQUFRLEdBQUcsYUFBYSxFQUFFO1lBQ2pDLE1BQU0sSUFBSSxLQUFLLENBQ2Isa0RBQWtELElBQUksQ0FBQyxRQUFRLCtDQUErQyxhQUFhLFNBQVMsQ0FDckksQ0FBQztTQUNIO1FBRUQsSUFBSSxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsRUFBRTtZQUN0QixNQUFNLElBQUksS0FBSyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7U0FDeEU7SUFDSCxDQUFDO0NBQ0Y7QUFoUEQsd0JBZ1BDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcGxldGVkUGFydCxcbiAgQ29tcGxldGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kLFxuICBDcmVhdGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kLFxuICBDcmVhdGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kT3V0cHV0LFxuICBQdXRPYmplY3RDb21tYW5kLFxuICBQdXRPYmplY3RDb21tYW5kSW5wdXQsXG4gIFB1dE9iamVjdENvbW1hbmRPdXRwdXQsXG4gIFB1dE9iamVjdFRhZ2dpbmdDb21tYW5kLFxuICBTZXJ2aWNlT3V0cHV0VHlwZXMsXG4gIFRhZyxcbiAgVXBsb2FkUGFydENvbW1hbmQsXG59IGZyb20gXCJAYXdzLXNkay9jbGllbnQtczNcIjtcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcbmltcG9ydCB7IEJvZHlEYXRhVHlwZXMsIE9wdGlvbnMsIFByb2dyZXNzLCBTZXJ2aWNlQ2xpZW50cyB9IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQgeyBnZXRDaHVuayB9IGZyb20gXCIuL2NodW5rZXJcIjtcbmltcG9ydCB7IGJ5dGVMZW5ndGggfSBmcm9tIFwiLi9ieXRlbGVuZ3RoXCI7XG5pbXBvcnQgeyBBYm9ydENvbnRyb2xsZXIsIEFib3J0U2lnbmFsIH0gZnJvbSBcIkBhd3Mtc2RrL2Fib3J0LWNvbnRyb2xsZXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBSYXdEYXRhUGFydCB7XG4gIHBhcnROdW1iZXI6IG51bWJlcjtcbiAgZGF0YTogQm9keURhdGFUeXBlcztcbiAgbGFzdFBhcnQ/OiBib29sZWFuO1xufVxuXG5jb25zdCBNSU5fUEFSVF9TSVpFID0gMTAyNCAqIDEwMjQgKiA1O1xuXG5leHBvcnQgY2xhc3MgVXBsb2FkIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgLyoqXG4gICAqIFMzIG11bHRpcGFydCB1cGxvYWQgZG9lcyBub3QgYWxsb3cgbW9yZSB0aGFuIDEwMDAwIHBhcnRzLlxuICAgKi9cbiAgcHJpdmF0ZSBNQVhfUEFSVFMgPSAxMDAwMDtcblxuICAvLyBEZWZhdWx0cy5cbiAgcHJpdmF0ZSBxdWV1ZVNpemUgPSA0O1xuICBwcml2YXRlIHBhcnRTaXplID0gTUlOX1BBUlRfU0laRTtcbiAgcHJpdmF0ZSBsZWF2ZVBhcnRzT25FcnJvciA9IGZhbHNlO1xuICBwcml2YXRlIHRhZ3M6IFRhZ1tdID0gW107XG5cbiAgcHJpdmF0ZSBjbGllbnQ6IFNlcnZpY2VDbGllbnRzO1xuICBwcml2YXRlIHBhcmFtczogUHV0T2JqZWN0Q29tbWFuZElucHV0O1xuXG4gIC8vIHVzZWQgZm9yIHJlcG9ydGluZyBwcm9ncmVzcy5cbiAgcHJpdmF0ZSB0b3RhbEJ5dGVzPzogbnVtYmVyO1xuICBwcml2YXRlIGJ5dGVzVXBsb2FkZWRTb0ZhcjogbnVtYmVyO1xuXG4gIC8vIHVzZWQgaW4gdGhlIHVwbG9hZC5cbiAgcHJpdmF0ZSBhYm9ydENvbnRyb2xsZXI6IEFib3J0Q29udHJvbGxlcjtcbiAgcHJpdmF0ZSBjb25jdXJyZW50VXBsb2FkZXJzOiBQcm9taXNlPHZvaWQ+W10gPSBbXTtcbiAgcHJpdmF0ZSBjcmVhdGVNdWx0aVBhcnRQcm9taXNlPzogUHJvbWlzZTxDcmVhdGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kT3V0cHV0PjtcblxuICBwcml2YXRlIHVwbG9hZGVkUGFydHM6IENvbXBsZXRlZFBhcnRbXSA9IFtdO1xuICBwcml2YXRlIHVwbG9hZElkPzogc3RyaW5nO1xuICB1cGxvYWRFdmVudD86IHN0cmluZztcblxuICBwcml2YXRlIGlzTXVsdGlQYXJ0OiBib29sZWFuID0gdHJ1ZTtcbiAgcHJpdmF0ZSBwdXRSZXNwb25zZT86IFB1dE9iamVjdENvbW1hbmRPdXRwdXQ7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogT3B0aW9ucykge1xuICAgIHN1cGVyKCk7XG5cbiAgICAvLyBzZXQgZGVmYXVsdHMgZnJvbSBvcHRpb25zLlxuICAgIHRoaXMucXVldWVTaXplID0gb3B0aW9ucy5xdWV1ZVNpemUgfHwgdGhpcy5xdWV1ZVNpemU7XG4gICAgdGhpcy5wYXJ0U2l6ZSA9IG9wdGlvbnMucGFydFNpemUgfHwgdGhpcy5wYXJ0U2l6ZTtcbiAgICB0aGlzLmxlYXZlUGFydHNPbkVycm9yID0gb3B0aW9ucy5sZWF2ZVBhcnRzT25FcnJvciB8fCB0aGlzLmxlYXZlUGFydHNPbkVycm9yO1xuICAgIHRoaXMudGFncyA9IG9wdGlvbnMudGFncyB8fCB0aGlzLnRhZ3M7XG5cbiAgICB0aGlzLmNsaWVudCA9IG9wdGlvbnMuY2xpZW50O1xuICAgIHRoaXMucGFyYW1zID0gb3B0aW9ucy5wYXJhbXM7XG5cbiAgICB0aGlzLl9fdmFsaWRhdGVJbnB1dCgpO1xuXG4gICAgLy8gc2V0IHByb2dyZXNzIGRlZmF1bHRzXG4gICAgdGhpcy50b3RhbEJ5dGVzID0gYnl0ZUxlbmd0aCh0aGlzLnBhcmFtcy5Cb2R5KTtcbiAgICB0aGlzLmJ5dGVzVXBsb2FkZWRTb0ZhciA9IDA7XG4gICAgdGhpcy5hYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gIH1cblxuICBhc3luYyBhYm9ydCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvKipcbiAgICAgKiBBYm9ydCBzdG9wcyBhbGwgbmV3IHVwbG9hZHMgYW5kIGltbWVkaWF0ZWx5IGV4aXN0cyB0aGUgdG9wIGxldmVsIHByb21pc2Ugb24gdGhpcy5kb25lKClcbiAgICAgKiBDb25jdXJyZW50IHRocmVhZHMgaW4gZmxpZ2h0IGNsZWFuIHVwIGV2ZW50dWFsbHkuXG4gICAgICovXG4gICAgdGhpcy5hYm9ydENvbnRyb2xsZXIuYWJvcnQoKTtcbiAgfVxuXG4gIGFzeW5jIGRvbmUoKTogUHJvbWlzZTxTZXJ2aWNlT3V0cHV0VHlwZXM+IHtcbiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5yYWNlKFt0aGlzLl9fZG9NdWx0aXBhcnRVcGxvYWQoKSwgdGhpcy5fX2Fib3J0VGltZW91dCh0aGlzLmFib3J0Q29udHJvbGxlci5zaWduYWwpXSk7XG4gIH1cblxuICBvbihldmVudDogXCJodHRwVXBsb2FkUHJvZ3Jlc3NcIiwgbGlzdGVuZXI6IChwcm9ncmVzczogUHJvZ3Jlc3MpID0+IHZvaWQpOiBhbnkge1xuICAgIHRoaXMudXBsb2FkRXZlbnQgPSBldmVudDtcbiAgICBzdXBlci5vbihldmVudCwgbGlzdGVuZXIpO1xuICB9XG5cbiAgYXN5bmMgX191cGxvYWRVc2luZ1B1dChkYXRhUGFydDogUmF3RGF0YVBhcnQpIHtcbiAgICB0aGlzLmlzTXVsdGlQYXJ0ID0gZmFsc2U7XG4gICAgY29uc3QgcGFyYW1zID0geyAuLi50aGlzLnBhcmFtcywgQm9keTogZGF0YVBhcnQuZGF0YSB9O1xuICAgIGNvbnN0IHB1dFJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LnNlbmQobmV3IFB1dE9iamVjdENvbW1hbmQocGFyYW1zKSk7XG4gICAgdGhpcy5wdXRSZXNwb25zZSA9IHB1dFJlc3VsdDtcbiAgICBjb25zdCB0b3RhbFNpemUgPSBieXRlTGVuZ3RoKGRhdGFQYXJ0LmRhdGEpO1xuICAgIHRoaXMuX19ub3RpZnlQcm9ncmVzcyh7XG4gICAgICBsb2FkZWQ6IHRvdGFsU2l6ZSxcbiAgICAgIHRvdGFsOiB0b3RhbFNpemUsXG4gICAgICBwYXJ0OiAxLFxuICAgICAgS2V5OiB0aGlzLnBhcmFtcy5LZXksXG4gICAgICBCdWNrZXQ6IHRoaXMucGFyYW1zLkJ1Y2tldCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIF9fY3JlYXRlTXVsdGlwYXJ0VXBsb2FkKCkge1xuICAgIGlmICghdGhpcy5jcmVhdGVNdWx0aVBhcnRQcm9taXNlKSB7XG4gICAgICBjb25zdCBjcmVhdGVDb21tYW5kUGFyYW1zID0geyAuLi50aGlzLnBhcmFtcywgQm9keTogdW5kZWZpbmVkIH07XG4gICAgICB0aGlzLmNyZWF0ZU11bHRpUGFydFByb21pc2UgPSB0aGlzLmNsaWVudC5zZW5kKG5ldyBDcmVhdGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kKGNyZWF0ZUNvbW1hbmRQYXJhbXMpKTtcbiAgICB9XG4gICAgY29uc3QgY3JlYXRlTXVsdGlwYXJ0VXBsb2FkUmVzdWx0ID0gYXdhaXQgdGhpcy5jcmVhdGVNdWx0aVBhcnRQcm9taXNlO1xuICAgIHRoaXMudXBsb2FkSWQgPSBjcmVhdGVNdWx0aXBhcnRVcGxvYWRSZXN1bHQuVXBsb2FkSWQ7XG4gIH1cblxuICBhc3luYyBfX2RvQ29uY3VycmVudFVwbG9hZChkYXRhRmVlZGVyOiBBc3luY0dlbmVyYXRvcjxSYXdEYXRhUGFydCwgdm9pZCwgdW5kZWZpbmVkPik6IFByb21pc2U8dm9pZD4ge1xuICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YVBhcnQgb2YgZGF0YUZlZWRlcikge1xuICAgICAgaWYgKHRoaXMudXBsb2FkZWRQYXJ0cy5sZW5ndGggPiB0aGlzLk1BWF9QQVJUUykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEV4Y2VlZGVkICR7dGhpcy5NQVhfUEFSVFN9IGFzIHBhcnQgb2YgdGhlIHVwbG9hZCB0byAke3RoaXMucGFyYW1zLktleX0gYW5kICR7dGhpcy5wYXJhbXMuQnVja2V0fS5gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGlmICh0aGlzLmFib3J0Q29udHJvbGxlci5zaWduYWwuYWJvcnRlZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFVzZSBwdXQgaW5zdGVhZCBvZiBtdWx0aS1wYXJ0IGZvciBvbmUgY2h1bmsgdXBsb2Fkcy5cbiAgICAgICAgaWYgKGRhdGFQYXJ0LnBhcnROdW1iZXIgPT09IDEgJiYgZGF0YVBhcnQubGFzdFBhcnQpIHtcbiAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fX3VwbG9hZFVzaW5nUHV0KGRhdGFQYXJ0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy51cGxvYWRJZCkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuX19jcmVhdGVNdWx0aXBhcnRVcGxvYWQoKTtcbiAgICAgICAgICBpZiAodGhpcy5hYm9ydENvbnRyb2xsZXIuc2lnbmFsLmFib3J0ZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXJ0UmVzdWx0ID0gYXdhaXQgdGhpcy5jbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgVXBsb2FkUGFydENvbW1hbmQoe1xuICAgICAgICAgICAgLi4udGhpcy5wYXJhbXMsXG4gICAgICAgICAgICBVcGxvYWRJZDogdGhpcy51cGxvYWRJZCxcbiAgICAgICAgICAgIEJvZHk6IGRhdGFQYXJ0LmRhdGEsXG4gICAgICAgICAgICBQYXJ0TnVtYmVyOiBkYXRhUGFydC5wYXJ0TnVtYmVyLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHRoaXMuYWJvcnRDb250cm9sbGVyLnNpZ25hbC5hYm9ydGVkKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy51cGxvYWRlZFBhcnRzLnB1c2goe1xuICAgICAgICAgIFBhcnROdW1iZXI6IGRhdGFQYXJ0LnBhcnROdW1iZXIsXG4gICAgICAgICAgRVRhZzogcGFydFJlc3VsdC5FVGFnLFxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmJ5dGVzVXBsb2FkZWRTb0ZhciArPSBieXRlTGVuZ3RoKGRhdGFQYXJ0LmRhdGEpO1xuICAgICAgICB0aGlzLl9fbm90aWZ5UHJvZ3Jlc3Moe1xuICAgICAgICAgIGxvYWRlZDogdGhpcy5ieXRlc1VwbG9hZGVkU29GYXIsXG4gICAgICAgICAgdG90YWw6IHRoaXMudG90YWxCeXRlcyxcbiAgICAgICAgICBwYXJ0OiBkYXRhUGFydC5wYXJ0TnVtYmVyLFxuICAgICAgICAgIEtleTogdGhpcy5wYXJhbXMuS2V5LFxuICAgICAgICAgIEJ1Y2tldDogdGhpcy5wYXJhbXMuQnVja2V0LFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gRmFpbGVkIHRvIGNyZWF0ZSBtdWx0aS1wYXJ0IG9yIHB1dFxuICAgICAgICBpZiAoIXRoaXMudXBsb2FkSWQpIHtcbiAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG4gICAgICAgIC8vIG9uIGxlYXZlUGFydHNPbkVycm9yIHRocm93IGFuIGVycm9yIHNvIHVzZXJzIGNhbiBkZWFsIHdpdGggaXQgdGhlbXNlbHZlcyxcbiAgICAgICAgLy8gb3RoZXJ3aXNlIHN3YWxsb3cgdGhlIGVycm9yLlxuICAgICAgICBpZiAodGhpcy5sZWF2ZVBhcnRzT25FcnJvcikge1xuICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBfX2RvTXVsdGlwYXJ0VXBsb2FkKCk6IFByb21pc2U8U2VydmljZU91dHB1dFR5cGVzPiB7XG4gICAgLy8gU2V0IHVwIGRhdGEgaW5wdXQgY2h1bmtzLlxuICAgIGNvbnN0IGRhdGFGZWVkZXIgPSBnZXRDaHVuayh0aGlzLnBhcmFtcy5Cb2R5LCB0aGlzLnBhcnRTaXplKTtcblxuICAgIC8vIENyZWF0ZSBhbmQgc3RhcnQgY29uY3VycmVudCB1cGxvYWRzLlxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0aGlzLnF1ZXVlU2l6ZTsgaW5kZXgrKykge1xuICAgICAgY29uc3QgY3VycmVudFVwbG9hZCA9IHRoaXMuX19kb0NvbmN1cnJlbnRVcGxvYWQoZGF0YUZlZWRlcik7XG4gICAgICB0aGlzLmNvbmN1cnJlbnRVcGxvYWRlcnMucHVzaChjdXJyZW50VXBsb2FkKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgYW5kIHN0YXJ0IGNvbmN1cnJlbnQgdXBsb2Fkcy5cbiAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLmNvbmN1cnJlbnRVcGxvYWRlcnMpO1xuICAgIGlmICh0aGlzLmFib3J0Q29udHJvbGxlci5zaWduYWwuYWJvcnRlZCkge1xuICAgICAgdGhyb3cgT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IoXCJVcGxvYWQgYWJvcnRlZC5cIiksIHsgbmFtZTogXCJBYm9ydEVycm9yXCIgfSk7XG4gICAgfVxuXG4gICAgbGV0IHJlc3VsdDtcbiAgICBpZiAodGhpcy5pc011bHRpUGFydCkge1xuICAgICAgdGhpcy51cGxvYWRlZFBhcnRzLnNvcnQoKGEsIGIpID0+IGEuUGFydE51bWJlciEgLSBiLlBhcnROdW1iZXIhKTtcblxuICAgICAgY29uc3QgdXBsb2FkQ29tcGxldGVQYXJhbXMgPSB7XG4gICAgICAgIC4uLnRoaXMucGFyYW1zLFxuICAgICAgICBCb2R5OiB1bmRlZmluZWQsXG4gICAgICAgIFVwbG9hZElkOiB0aGlzLnVwbG9hZElkLFxuICAgICAgICBNdWx0aXBhcnRVcGxvYWQ6IHtcbiAgICAgICAgICBQYXJ0czogdGhpcy51cGxvYWRlZFBhcnRzLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LnNlbmQobmV3IENvbXBsZXRlTXVsdGlwYXJ0VXBsb2FkQ29tbWFuZCh1cGxvYWRDb21wbGV0ZVBhcmFtcykpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSB0aGlzLnB1dFJlc3BvbnNlITtcbiAgICB9XG5cbiAgICAvLyBBZGQgdGFncyB0byB0aGUgb2JqZWN0IGFmdGVyIGl0J3MgY29tcGxldGVkIHRoZSB1cGxvYWQuXG4gICAgaWYgKHRoaXMudGFncy5sZW5ndGgpIHtcbiAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBQdXRPYmplY3RUYWdnaW5nQ29tbWFuZCh7XG4gICAgICAgICAgLi4udGhpcy5wYXJhbXMsXG4gICAgICAgICAgVGFnZ2luZzoge1xuICAgICAgICAgICAgVGFnU2V0OiB0aGlzLnRhZ3MsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIF9fbm90aWZ5UHJvZ3Jlc3MocHJvZ3Jlc3M6IFByb2dyZXNzKSB7XG4gICAgaWYgKHRoaXMudXBsb2FkRXZlbnQpIHtcbiAgICAgIHRoaXMuZW1pdCh0aGlzLnVwbG9hZEV2ZW50LCBwcm9ncmVzcyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX19hYm9ydFRpbWVvdXQoYWJvcnRTaWduYWw6IEFib3J0U2lnbmFsKTogUHJvbWlzZTxTZXJ2aWNlT3V0cHV0VHlwZXM+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgYWJvcnRTaWduYWwub25hYm9ydCA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgYWJvcnRFcnJvciA9IG5ldyBFcnJvcihcIlVwbG9hZCBhYm9ydGVkLlwiKTtcbiAgICAgICAgYWJvcnRFcnJvci5uYW1lID0gXCJBYm9ydEVycm9yXCI7XG4gICAgICAgIHJlamVjdChhYm9ydEVycm9yKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBfX3ZhbGlkYXRlSW5wdXQoKSB7XG4gICAgaWYgKCF0aGlzLnBhcmFtcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnB1dEVycm9yOiBVcGxvYWQgcmVxdWlyZXMgcGFyYW1zIHRvIGJlIHBhc3NlZCB0byB1cGxvYWQuYCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmNsaWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnB1dEVycm9yOiBVcGxvYWQgcmVxdWlyZXMgYSBBV1MgY2xpZW50IHRvIGRvIHVwbG9hZHMgd2l0aC5gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wYXJ0U2l6ZSA8IE1JTl9QQVJUX1NJWkUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEVudGl0eVRvb1NtYWxsOiBZb3VyIHByb3Bvc2VkIHVwbG9hZCBwYXJ0c2l6ZSBbJHt0aGlzLnBhcnRTaXplfV0gaXMgc21hbGxlciB0aGFuIHRoZSBtaW5pbXVtIGFsbG93ZWQgc2l6ZSBbJHtNSU5fUEFSVF9TSVpFfV0gKDVNQilgXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnF1ZXVlU2l6ZSA8IDEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUXVldWUgc2l6ZTogTXVzdCBoYXZlIGF0IGxlYXN0IG9uZSB1cGxvYWRpbmcgcXVldWUuYCk7XG4gICAgfVxuICB9XG59XG4iXX0=