import { __assign, __asyncValues, __awaiter, __extends, __generator } from "tslib";
import { CompleteMultipartUploadCommand, CreateMultipartUploadCommand, PutObjectCommand, PutObjectTaggingCommand, UploadPartCommand, } from "@aws-sdk/client-s3";
import { EventEmitter } from "events";
import { getChunk } from "./chunker";
import { byteLength } from "./bytelength";
import { AbortController } from "@aws-sdk/abort-controller";
var MIN_PART_SIZE = 1024 * 1024 * 5;
var Upload = /** @class */ (function (_super) {
    __extends(Upload, _super);
    function Upload(options) {
        var _this = _super.call(this) || this;
        /**
         * S3 multipart upload does not allow more than 10000 parts.
         */
        _this.MAX_PARTS = 10000;
        // Defaults.
        _this.queueSize = 4;
        _this.partSize = MIN_PART_SIZE;
        _this.leavePartsOnError = false;
        _this.tags = [];
        _this.concurrentUploaders = [];
        _this.uploadedParts = [];
        _this.isMultiPart = true;
        // set defaults from options.
        _this.queueSize = options.queueSize || _this.queueSize;
        _this.partSize = options.partSize || _this.partSize;
        _this.leavePartsOnError = options.leavePartsOnError || _this.leavePartsOnError;
        _this.tags = options.tags || _this.tags;
        _this.client = options.client;
        _this.params = options.params;
        _this.__validateInput();
        // set progress defaults
        _this.totalBytes = byteLength(_this.params.Body);
        _this.bytesUploadedSoFar = 0;
        _this.abortController = new AbortController();
        return _this;
    }
    Upload.prototype.abort = function () {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                /**
                 * Abort stops all new uploads and immediately exists the top level promise on this.done()
                 * Concurrent threads in flight clean up eventually.
                 */
                this.abortController.abort();
                return [2 /*return*/];
            });
        });
    };
    Upload.prototype.done = function () {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, Promise.race([this.__doMultipartUpload(), this.__abortTimeout(this.abortController.signal)])];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    Upload.prototype.on = function (event, listener) {
        this.uploadEvent = event;
        _super.prototype.on.call(this, event, listener);
    };
    Upload.prototype.__uploadUsingPut = function (dataPart) {
        return __awaiter(this, void 0, void 0, function () {
            var params, putResult, totalSize;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.isMultiPart = false;
                        params = __assign(__assign({}, this.params), { Body: dataPart.data });
                        return [4 /*yield*/, this.client.send(new PutObjectCommand(params))];
                    case 1:
                        putResult = _a.sent();
                        this.putResponse = putResult;
                        totalSize = byteLength(dataPart.data);
                        this.__notifyProgress({
                            loaded: totalSize,
                            total: totalSize,
                            part: 1,
                            Key: this.params.Key,
                            Bucket: this.params.Bucket,
                        });
                        return [2 /*return*/];
                }
            });
        });
    };
    Upload.prototype.__createMultipartUpload = function () {
        return __awaiter(this, void 0, void 0, function () {
            var createCommandParams, createMultipartUploadResult;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!this.createMultiPartPromise) {
                            createCommandParams = __assign(__assign({}, this.params), { Body: undefined });
                            this.createMultiPartPromise = this.client.send(new CreateMultipartUploadCommand(createCommandParams));
                        }
                        return [4 /*yield*/, this.createMultiPartPromise];
                    case 1:
                        createMultipartUploadResult = _a.sent();
                        this.uploadId = createMultipartUploadResult.UploadId;
                        return [2 /*return*/];
                }
            });
        });
    };
    Upload.prototype.__doConcurrentUpload = function (dataFeeder) {
        var dataFeeder_1, dataFeeder_1_1;
        var e_1, _a;
        return __awaiter(this, void 0, void 0, function () {
            var dataPart, partResult, e_2, e_1_1;
            return __generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _b.trys.push([0, 12, 13, 18]);
                        dataFeeder_1 = __asyncValues(dataFeeder);
                        _b.label = 1;
                    case 1: return [4 /*yield*/, dataFeeder_1.next()];
                    case 2:
                        if (!(dataFeeder_1_1 = _b.sent(), !dataFeeder_1_1.done)) return [3 /*break*/, 11];
                        dataPart = dataFeeder_1_1.value;
                        if (this.uploadedParts.length > this.MAX_PARTS) {
                            throw new Error("Exceeded " + this.MAX_PARTS + " as part of the upload to " + this.params.Key + " and " + this.params.Bucket + ".");
                        }
                        _b.label = 3;
                    case 3:
                        _b.trys.push([3, 9, , 10]);
                        if (this.abortController.signal.aborted) {
                            return [2 /*return*/];
                        }
                        if (!(dataPart.partNumber === 1 && dataPart.lastPart)) return [3 /*break*/, 5];
                        return [4 /*yield*/, this.__uploadUsingPut(dataPart)];
                    case 4: return [2 /*return*/, _b.sent()];
                    case 5:
                        if (!!this.uploadId) return [3 /*break*/, 7];
                        return [4 /*yield*/, this.__createMultipartUpload()];
                    case 6:
                        _b.sent();
                        if (this.abortController.signal.aborted) {
                            return [2 /*return*/];
                        }
                        _b.label = 7;
                    case 7: return [4 /*yield*/, this.client.send(new UploadPartCommand(__assign(__assign({}, this.params), { UploadId: this.uploadId, Body: dataPart.data, PartNumber: dataPart.partNumber })))];
                    case 8:
                        partResult = _b.sent();
                        if (this.abortController.signal.aborted) {
                            return [2 /*return*/];
                        }
                        this.uploadedParts.push({
                            PartNumber: dataPart.partNumber,
                            ETag: partResult.ETag,
                        });
                        this.bytesUploadedSoFar += byteLength(dataPart.data);
                        this.__notifyProgress({
                            loaded: this.bytesUploadedSoFar,
                            total: this.totalBytes,
                            part: dataPart.partNumber,
                            Key: this.params.Key,
                            Bucket: this.params.Bucket,
                        });
                        return [3 /*break*/, 10];
                    case 9:
                        e_2 = _b.sent();
                        // Failed to create multi-part or put
                        if (!this.uploadId) {
                            throw e_2;
                        }
                        // on leavePartsOnError throw an error so users can deal with it themselves,
                        // otherwise swallow the error.
                        if (this.leavePartsOnError) {
                            throw e_2;
                        }
                        return [3 /*break*/, 10];
                    case 10: return [3 /*break*/, 1];
                    case 11: return [3 /*break*/, 18];
                    case 12:
                        e_1_1 = _b.sent();
                        e_1 = { error: e_1_1 };
                        return [3 /*break*/, 18];
                    case 13:
                        _b.trys.push([13, , 16, 17]);
                        if (!(dataFeeder_1_1 && !dataFeeder_1_1.done && (_a = dataFeeder_1.return))) return [3 /*break*/, 15];
                        return [4 /*yield*/, _a.call(dataFeeder_1)];
                    case 14:
                        _b.sent();
                        _b.label = 15;
                    case 15: return [3 /*break*/, 17];
                    case 16:
                        if (e_1) throw e_1.error;
                        return [7 /*endfinally*/];
                    case 17: return [7 /*endfinally*/];
                    case 18: return [2 /*return*/];
                }
            });
        });
    };
    Upload.prototype.__doMultipartUpload = function () {
        return __awaiter(this, void 0, void 0, function () {
            var dataFeeder, index, currentUpload, result, uploadCompleteParams;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        dataFeeder = getChunk(this.params.Body, this.partSize);
                        // Create and start concurrent uploads.
                        for (index = 0; index < this.queueSize; index++) {
                            currentUpload = this.__doConcurrentUpload(dataFeeder);
                            this.concurrentUploaders.push(currentUpload);
                        }
                        // Create and start concurrent uploads.
                        return [4 /*yield*/, Promise.all(this.concurrentUploaders)];
                    case 1:
                        // Create and start concurrent uploads.
                        _a.sent();
                        if (this.abortController.signal.aborted) {
                            throw Object.assign(new Error("Upload aborted."), { name: "AbortError" });
                        }
                        if (!this.isMultiPart) return [3 /*break*/, 3];
                        this.uploadedParts.sort(function (a, b) { return a.PartNumber - b.PartNumber; });
                        uploadCompleteParams = __assign(__assign({}, this.params), { Body: undefined, UploadId: this.uploadId, MultipartUpload: {
                                Parts: this.uploadedParts,
                            } });
                        return [4 /*yield*/, this.client.send(new CompleteMultipartUploadCommand(uploadCompleteParams))];
                    case 2:
                        result = _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        result = this.putResponse;
                        _a.label = 4;
                    case 4:
                        if (!this.tags.length) return [3 /*break*/, 6];
                        return [4 /*yield*/, this.client.send(new PutObjectTaggingCommand(__assign(__assign({}, this.params), { Tagging: {
                                    TagSet: this.tags,
                                } })))];
                    case 5:
                        _a.sent();
                        _a.label = 6;
                    case 6: return [2 /*return*/, result];
                }
            });
        });
    };
    Upload.prototype.__notifyProgress = function (progress) {
        if (this.uploadEvent) {
            this.emit(this.uploadEvent, progress);
        }
    };
    Upload.prototype.__abortTimeout = function (abortSignal) {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                return [2 /*return*/, new Promise(function (resolve, reject) {
                        abortSignal.onabort = function () {
                            var abortError = new Error("Upload aborted.");
                            abortError.name = "AbortError";
                            reject(abortError);
                        };
                    })];
            });
        });
    };
    Upload.prototype.__validateInput = function () {
        if (!this.params) {
            throw new Error("InputError: Upload requires params to be passed to upload.");
        }
        if (!this.client) {
            throw new Error("InputError: Upload requires a AWS client to do uploads with.");
        }
        if (this.partSize < MIN_PART_SIZE) {
            throw new Error("EntityTooSmall: Your proposed upload partsize [" + this.partSize + "] is smaller than the minimum allowed size [" + MIN_PART_SIZE + "] (5MB)");
        }
        if (this.queueSize < 1) {
            throw new Error("Queue size: Must have at least one uploading queue.");
        }
    };
    return Upload;
}(EventEmitter));
export { Upload };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXBsb2FkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL1VwbG9hZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUVMLDhCQUE4QixFQUM5Qiw0QkFBNEIsRUFFNUIsZ0JBQWdCLEVBR2hCLHVCQUF1QixFQUd2QixpQkFBaUIsR0FDbEIsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBRXRDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDckMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsZUFBZSxFQUFlLE1BQU0sMkJBQTJCLENBQUM7QUFRekUsSUFBTSxhQUFhLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLENBQUM7QUFFdEM7SUFBNEIsMEJBQVk7SUErQnRDLGdCQUFZLE9BQWdCO1FBQTVCLFlBQ0UsaUJBQU8sU0FpQlI7UUFoREQ7O1dBRUc7UUFDSyxlQUFTLEdBQUcsS0FBSyxDQUFDO1FBRTFCLFlBQVk7UUFDSixlQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsY0FBUSxHQUFHLGFBQWEsQ0FBQztRQUN6Qix1QkFBaUIsR0FBRyxLQUFLLENBQUM7UUFDMUIsVUFBSSxHQUFVLEVBQUUsQ0FBQztRQVdqQix5QkFBbUIsR0FBb0IsRUFBRSxDQUFDO1FBRzFDLG1CQUFhLEdBQW9CLEVBQUUsQ0FBQztRQUlwQyxpQkFBVyxHQUFZLElBQUksQ0FBQztRQU1sQyw2QkFBNkI7UUFDN0IsS0FBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxJQUFJLEtBQUksQ0FBQyxTQUFTLENBQUM7UUFDckQsS0FBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsUUFBUSxJQUFJLEtBQUksQ0FBQyxRQUFRLENBQUM7UUFDbEQsS0FBSSxDQUFDLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxp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OlsiaW1wb3J0IHtcbiAgQ29tcGxldGVkUGFydCxcbiAgQ29tcGxldGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kLFxuICBDcmVhdGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kLFxuICBDcmVhdGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kT3V0cHV0LFxuICBQdXRPYmplY3RDb21tYW5kLFxuICBQdXRPYmplY3RDb21tYW5kSW5wdXQsXG4gIFB1dE9iamVjdENvbW1hbmRPdXRwdXQsXG4gIFB1dE9iamVjdFRhZ2dpbmdDb21tYW5kLFxuICBTZXJ2aWNlT3V0cHV0VHlwZXMsXG4gIFRhZyxcbiAgVXBsb2FkUGFydENvbW1hbmQsXG59IGZyb20gXCJAYXdzLXNkay9jbGllbnQtczNcIjtcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcbmltcG9ydCB7IEJvZHlEYXRhVHlwZXMsIE9wdGlvbnMsIFByb2dyZXNzLCBTZXJ2aWNlQ2xpZW50cyB9IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQgeyBnZXRDaHVuayB9IGZyb20gXCIuL2NodW5rZXJcIjtcbmltcG9ydCB7IGJ5dGVMZW5ndGggfSBmcm9tIFwiLi9ieXRlbGVuZ3RoXCI7XG5pbXBvcnQgeyBBYm9ydENvbnRyb2xsZXIsIEFib3J0U2lnbmFsIH0gZnJvbSBcIkBhd3Mtc2RrL2Fib3J0LWNvbnRyb2xsZXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBSYXdEYXRhUGFydCB7XG4gIHBhcnROdW1iZXI6IG51bWJlcjtcbiAgZGF0YTogQm9keURhdGFUeXBlcztcbiAgbGFzdFBhcnQ/OiBib29sZWFuO1xufVxuXG5jb25zdCBNSU5fUEFSVF9TSVpFID0gMTAyNCAqIDEwMjQgKiA1O1xuXG5leHBvcnQgY2xhc3MgVXBsb2FkIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgLyoqXG4gICAqIFMzIG11bHRpcGFydCB1cGxvYWQgZG9lcyBub3QgYWxsb3cgbW9yZSB0aGFuIDEwMDAwIHBhcnRzLlxuICAgKi9cbiAgcHJpdmF0ZSBNQVhfUEFSVFMgPSAxMDAwMDtcblxuICAvLyBEZWZhdWx0cy5cbiAgcHJpdmF0ZSBxdWV1ZVNpemUgPSA0O1xuICBwcml2YXRlIHBhcnRTaXplID0gTUlOX1BBUlRfU0laRTtcbiAgcHJpdmF0ZSBsZWF2ZVBhcnRzT25FcnJvciA9IGZhbHNlO1xuICBwcml2YXRlIHRhZ3M6IFRhZ1tdID0gW107XG5cbiAgcHJpdmF0ZSBjbGllbnQ6IFNlcnZpY2VDbGllbnRzO1xuICBwcml2YXRlIHBhcmFtczogUHV0T2JqZWN0Q29tbWFuZElucHV0O1xuXG4gIC8vIHVzZWQgZm9yIHJlcG9ydGluZyBwcm9ncmVzcy5cbiAgcHJpdmF0ZSB0b3RhbEJ5dGVzPzogbnVtYmVyO1xuICBwcml2YXRlIGJ5dGVzVXBsb2FkZWRTb0ZhcjogbnVtYmVyO1xuXG4gIC8vIHVzZWQgaW4gdGhlIHVwbG9hZC5cbiAgcHJpdmF0ZSBhYm9ydENvbnRyb2xsZXI6IEFib3J0Q29udHJvbGxlcjtcbiAgcHJpdmF0ZSBjb25jdXJyZW50VXBsb2FkZXJzOiBQcm9taXNlPHZvaWQ+W10gPSBbXTtcbiAgcHJpdmF0ZSBjcmVhdGVNdWx0aVBhcnRQcm9taXNlPzogUHJvbWlzZTxDcmVhdGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kT3V0cHV0PjtcblxuICBwcml2YXRlIHVwbG9hZGVkUGFydHM6IENvbXBsZXRlZFBhcnRbXSA9IFtdO1xuICBwcml2YXRlIHVwbG9hZElkPzogc3RyaW5nO1xuICB1cGxvYWRFdmVudD86IHN0cmluZztcblxuICBwcml2YXRlIGlzTXVsdGlQYXJ0OiBib29sZWFuID0gdHJ1ZTtcbiAgcHJpdmF0ZSBwdXRSZXNwb25zZT86IFB1dE9iamVjdENvbW1hbmRPdXRwdXQ7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogT3B0aW9ucykge1xuICAgIHN1cGVyKCk7XG5cbiAgICAvLyBzZXQgZGVmYXVsdHMgZnJvbSBvcHRpb25zLlxuICAgIHRoaXMucXVldWVTaXplID0gb3B0aW9ucy5xdWV1ZVNpemUgfHwgdGhpcy5xdWV1ZVNpemU7XG4gICAgdGhpcy5wYXJ0U2l6ZSA9IG9wdGlvbnMucGFydFNpemUgfHwgdGhpcy5wYXJ0U2l6ZTtcbiAgICB0aGlzLmxlYXZlUGFydHNPbkVycm9yID0gb3B0aW9ucy5sZWF2ZVBhcnRzT25FcnJvciB8fCB0aGlzLmxlYXZlUGFydHNPbkVycm9yO1xuICAgIHRoaXMudGFncyA9IG9wdGlvbnMudGFncyB8fCB0aGlzLnRhZ3M7XG5cbiAgICB0aGlzLmNsaWVudCA9IG9wdGlvbnMuY2xpZW50O1xuICAgIHRoaXMucGFyYW1zID0gb3B0aW9ucy5wYXJhbXM7XG5cbiAgICB0aGlzLl9fdmFsaWRhdGVJbnB1dCgpO1xuXG4gICAgLy8gc2V0IHByb2dyZXNzIGRlZmF1bHRzXG4gICAgdGhpcy50b3RhbEJ5dGVzID0gYnl0ZUxlbmd0aCh0aGlzLnBhcmFtcy5Cb2R5KTtcbiAgICB0aGlzLmJ5dGVzVXBsb2FkZWRTb0ZhciA9IDA7XG4gICAgdGhpcy5hYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gIH1cblxuICBhc3luYyBhYm9ydCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvKipcbiAgICAgKiBBYm9ydCBzdG9wcyBhbGwgbmV3IHVwbG9hZHMgYW5kIGltbWVkaWF0ZWx5IGV4aXN0cyB0aGUgdG9wIGxldmVsIHByb21pc2Ugb24gdGhpcy5kb25lKClcbiAgICAgKiBDb25jdXJyZW50IHRocmVhZHMgaW4gZmxpZ2h0IGNsZWFuIHVwIGV2ZW50dWFsbHkuXG4gICAgICovXG4gICAgdGhpcy5hYm9ydENvbnRyb2xsZXIuYWJvcnQoKTtcbiAgfVxuXG4gIGFzeW5jIGRvbmUoKTogUHJvbWlzZTxTZXJ2aWNlT3V0cHV0VHlwZXM+IHtcbiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5yYWNlKFt0aGlzLl9fZG9NdWx0aXBhcnRVcGxvYWQoKSwgdGhpcy5fX2Fib3J0VGltZW91dCh0aGlzLmFib3J0Q29udHJvbGxlci5zaWduYWwpXSk7XG4gIH1cblxuICBvbihldmVudDogXCJodHRwVXBsb2FkUHJvZ3Jlc3NcIiwgbGlzdGVuZXI6IChwcm9ncmVzczogUHJvZ3Jlc3MpID0+IHZvaWQpOiBhbnkge1xuICAgIHRoaXMudXBsb2FkRXZlbnQgPSBldmVudDtcbiAgICBzdXBlci5vbihldmVudCwgbGlzdGVuZXIpO1xuICB9XG5cbiAgYXN5bmMgX191cGxvYWRVc2luZ1B1dChkYXRhUGFydDogUmF3RGF0YVBhcnQpIHtcbiAgICB0aGlzLmlzTXVsdGlQYXJ0ID0gZmFsc2U7XG4gICAgY29uc3QgcGFyYW1zID0geyAuLi50aGlzLnBhcmFtcywgQm9keTogZGF0YVBhcnQuZGF0YSB9O1xuICAgIGNvbnN0IHB1dFJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LnNlbmQobmV3IFB1dE9iamVjdENvbW1hbmQocGFyYW1zKSk7XG4gICAgdGhpcy5wdXRSZXNwb25zZSA9IHB1dFJlc3VsdDtcbiAgICBjb25zdCB0b3RhbFNpemUgPSBieXRlTGVuZ3RoKGRhdGFQYXJ0LmRhdGEpO1xuICAgIHRoaXMuX19ub3RpZnlQcm9ncmVzcyh7XG4gICAgICBsb2FkZWQ6IHRvdGFsU2l6ZSxcbiAgICAgIHRvdGFsOiB0b3RhbFNpemUsXG4gICAgICBwYXJ0OiAxLFxuICAgICAgS2V5OiB0aGlzLnBhcmFtcy5LZXksXG4gICAgICBCdWNrZXQ6IHRoaXMucGFyYW1zLkJ1Y2tldCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIF9fY3JlYXRlTXVsdGlwYXJ0VXBsb2FkKCkge1xuICAgIGlmICghdGhpcy5jcmVhdGVNdWx0aVBhcnRQcm9taXNlKSB7XG4gICAgICBjb25zdCBjcmVhdGVDb21tYW5kUGFyYW1zID0geyAuLi50aGlzLnBhcmFtcywgQm9keTogdW5kZWZpbmVkIH07XG4gICAgICB0aGlzLmNyZWF0ZU11bHRpUGFydFByb21pc2UgPSB0aGlzLmNsaWVudC5zZW5kKG5ldyBDcmVhdGVNdWx0aXBhcnRVcGxvYWRDb21tYW5kKGNyZWF0ZUNvbW1hbmRQYXJhbXMpKTtcbiAgICB9XG4gICAgY29uc3QgY3JlYXRlTXVsdGlwYXJ0VXBsb2FkUmVzdWx0ID0gYXdhaXQgdGhpcy5jcmVhdGVNdWx0aVBhcnRQcm9taXNlO1xuICAgIHRoaXMudXBsb2FkSWQgPSBjcmVhdGVNdWx0aXBhcnRVcGxvYWRSZXN1bHQuVXBsb2FkSWQ7XG4gIH1cblxuICBhc3luYyBfX2RvQ29uY3VycmVudFVwbG9hZChkYXRhRmVlZGVyOiBBc3luY0dlbmVyYXRvcjxSYXdEYXRhUGFydCwgdm9pZCwgdW5kZWZpbmVkPik6IFByb21pc2U8dm9pZD4ge1xuICAgIGZvciBhd2FpdCAoY29uc3QgZGF0YVBhcnQgb2YgZGF0YUZlZWRlcikge1xuICAgICAgaWYgKHRoaXMudXBsb2FkZWRQYXJ0cy5sZW5ndGggPiB0aGlzLk1BWF9QQVJUUykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEV4Y2VlZGVkICR7dGhpcy5NQVhfUEFSVFN9IGFzIHBhcnQgb2YgdGhlIHVwbG9hZCB0byAke3RoaXMucGFyYW1zLktleX0gYW5kICR7dGhpcy5wYXJhbXMuQnVja2V0fS5gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGlmICh0aGlzLmFib3J0Q29udHJvbGxlci5zaWduYWwuYWJvcnRlZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFVzZSBwdXQgaW5zdGVhZCBvZiBtdWx0aS1wYXJ0IGZvciBvbmUgY2h1bmsgdXBsb2Fkcy5cbiAgICAgICAgaWYgKGRhdGFQYXJ0LnBhcnROdW1iZXIgPT09IDEgJiYgZGF0YVBhcnQubGFzdFBhcnQpIHtcbiAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fX3VwbG9hZFVzaW5nUHV0KGRhdGFQYXJ0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy51cGxvYWRJZCkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuX19jcmVhdGVNdWx0aXBhcnRVcGxvYWQoKTtcbiAgICAgICAgICBpZiAodGhpcy5hYm9ydENvbnRyb2xsZXIuc2lnbmFsLmFib3J0ZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXJ0UmVzdWx0ID0gYXdhaXQgdGhpcy5jbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgVXBsb2FkUGFydENvbW1hbmQoe1xuICAgICAgICAgICAgLi4udGhpcy5wYXJhbXMsXG4gICAgICAgICAgICBVcGxvYWRJZDogdGhpcy51cGxvYWRJZCxcbiAgICAgICAgICAgIEJvZHk6IGRhdGFQYXJ0LmRhdGEsXG4gICAgICAgICAgICBQYXJ0TnVtYmVyOiBkYXRhUGFydC5wYXJ0TnVtYmVyLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHRoaXMuYWJvcnRDb250cm9sbGVyLnNpZ25hbC5hYm9ydGVkKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy51cGxvYWRlZFBhcnRzLnB1c2goe1xuICAgICAgICAgIFBhcnROdW1iZXI6IGRhdGFQYXJ0LnBhcnROdW1iZXIsXG4gICAgICAgICAgRVRhZzogcGFydFJlc3VsdC5FVGFnLFxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmJ5dGVzVXBsb2FkZWRTb0ZhciArPSBieXRlTGVuZ3RoKGRhdGFQYXJ0LmRhdGEpO1xuICAgICAgICB0aGlzLl9fbm90aWZ5UHJvZ3Jlc3Moe1xuICAgICAgICAgIGxvYWRlZDogdGhpcy5ieXRlc1VwbG9hZGVkU29GYXIsXG4gICAgICAgICAgdG90YWw6IHRoaXMudG90YWxCeXRlcyxcbiAgICAgICAgICBwYXJ0OiBkYXRhUGFydC5wYXJ0TnVtYmVyLFxuICAgICAgICAgIEtleTogdGhpcy5wYXJhbXMuS2V5LFxuICAgICAgICAgIEJ1Y2tldDogdGhpcy5wYXJhbXMuQnVja2V0LFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gRmFpbGVkIHRvIGNyZWF0ZSBtdWx0aS1wYXJ0IG9yIHB1dFxuICAgICAgICBpZiAoIXRoaXMudXBsb2FkSWQpIHtcbiAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG4gICAgICAgIC8vIG9uIGxlYXZlUGFydHNPbkVycm9yIHRocm93IGFuIGVycm9yIHNvIHVzZXJzIGNhbiBkZWFsIHdpdGggaXQgdGhlbXNlbHZlcyxcbiAgICAgICAgLy8gb3RoZXJ3aXNlIHN3YWxsb3cgdGhlIGVycm9yLlxuICAgICAgICBpZiAodGhpcy5sZWF2ZVBhcnRzT25FcnJvcikge1xuICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBfX2RvTXVsdGlwYXJ0VXBsb2FkKCk6IFByb21pc2U8U2VydmljZU91dHB1dFR5cGVzPiB7XG4gICAgLy8gU2V0IHVwIGRhdGEgaW5wdXQgY2h1bmtzLlxuICAgIGNvbnN0IGRhdGFGZWVkZXIgPSBnZXRDaHVuayh0aGlzLnBhcmFtcy5Cb2R5LCB0aGlzLnBhcnRTaXplKTtcblxuICAgIC8vIENyZWF0ZSBhbmQgc3RhcnQgY29uY3VycmVudCB1cGxvYWRzLlxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0aGlzLnF1ZXVlU2l6ZTsgaW5kZXgrKykge1xuICAgICAgY29uc3QgY3VycmVudFVwbG9hZCA9IHRoaXMuX19kb0NvbmN1cnJlbnRVcGxvYWQoZGF0YUZlZWRlcik7XG4gICAgICB0aGlzLmNvbmN1cnJlbnRVcGxvYWRlcnMucHVzaChjdXJyZW50VXBsb2FkKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgYW5kIHN0YXJ0IGNvbmN1cnJlbnQgdXBsb2Fkcy5cbiAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLmNvbmN1cnJlbnRVcGxvYWRlcnMpO1xuICAgIGlmICh0aGlzLmFib3J0Q29udHJvbGxlci5zaWduYWwuYWJvcnRlZCkge1xuICAgICAgdGhyb3cgT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IoXCJVcGxvYWQgYWJvcnRlZC5cIiksIHsgbmFtZTogXCJBYm9ydEVycm9yXCIgfSk7XG4gICAgfVxuXG4gICAgbGV0IHJlc3VsdDtcbiAgICBpZiAodGhpcy5pc011bHRpUGFydCkge1xuICAgICAgdGhpcy51cGxvYWRlZFBhcnRzLnNvcnQoKGEsIGIpID0+IGEuUGFydE51bWJlciEgLSBiLlBhcnROdW1iZXIhKTtcblxuICAgICAgY29uc3QgdXBsb2FkQ29tcGxldGVQYXJhbXMgPSB7XG4gICAgICAgIC4uLnRoaXMucGFyYW1zLFxuICAgICAgICBCb2R5OiB1bmRlZmluZWQsXG4gICAgICAgIFVwbG9hZElkOiB0aGlzLnVwbG9hZElkLFxuICAgICAgICBNdWx0aXBhcnRVcGxvYWQ6IHtcbiAgICAgICAgICBQYXJ0czogdGhpcy51cGxvYWRlZFBhcnRzLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LnNlbmQobmV3IENvbXBsZXRlTXVsdGlwYXJ0VXBsb2FkQ29tbWFuZCh1cGxvYWRDb21wbGV0ZVBhcmFtcykpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSB0aGlzLnB1dFJlc3BvbnNlITtcbiAgICB9XG5cbiAgICAvLyBBZGQgdGFncyB0byB0aGUgb2JqZWN0IGFmdGVyIGl0J3MgY29tcGxldGVkIHRoZSB1cGxvYWQuXG4gICAgaWYgKHRoaXMudGFncy5sZW5ndGgpIHtcbiAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBQdXRPYmplY3RUYWdnaW5nQ29tbWFuZCh7XG4gICAgICAgICAgLi4udGhpcy5wYXJhbXMsXG4gICAgICAgICAgVGFnZ2luZzoge1xuICAgICAgICAgICAgVGFnU2V0OiB0aGlzLnRhZ3MsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIF9fbm90aWZ5UHJvZ3Jlc3MocHJvZ3Jlc3M6IFByb2dyZXNzKSB7XG4gICAgaWYgKHRoaXMudXBsb2FkRXZlbnQpIHtcbiAgICAgIHRoaXMuZW1pdCh0aGlzLnVwbG9hZEV2ZW50LCBwcm9ncmVzcyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX19hYm9ydFRpbWVvdXQoYWJvcnRTaWduYWw6IEFib3J0U2lnbmFsKTogUHJvbWlzZTxTZXJ2aWNlT3V0cHV0VHlwZXM+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgYWJvcnRTaWduYWwub25hYm9ydCA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgYWJvcnRFcnJvciA9IG5ldyBFcnJvcihcIlVwbG9hZCBhYm9ydGVkLlwiKTtcbiAgICAgICAgYWJvcnRFcnJvci5uYW1lID0gXCJBYm9ydEVycm9yXCI7XG4gICAgICAgIHJlamVjdChhYm9ydEVycm9yKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBfX3ZhbGlkYXRlSW5wdXQoKSB7XG4gICAgaWYgKCF0aGlzLnBhcmFtcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnB1dEVycm9yOiBVcGxvYWQgcmVxdWlyZXMgcGFyYW1zIHRvIGJlIHBhc3NlZCB0byB1cGxvYWQuYCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmNsaWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnB1dEVycm9yOiBVcGxvYWQgcmVxdWlyZXMgYSBBV1MgY2xpZW50IHRvIGRvIHVwbG9hZHMgd2l0aC5gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wYXJ0U2l6ZSA8IE1JTl9QQVJUX1NJWkUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEVudGl0eVRvb1NtYWxsOiBZb3VyIHByb3Bvc2VkIHVwbG9hZCBwYXJ0c2l6ZSBbJHt0aGlzLnBhcnRTaXplfV0gaXMgc21hbGxlciB0aGFuIHRoZSBtaW5pbXVtIGFsbG93ZWQgc2l6ZSBbJHtNSU5fUEFSVF9TSVpFfV0gKDVNQilgXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnF1ZXVlU2l6ZSA8IDEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUXVldWUgc2l6ZTogTXVzdCBoYXZlIGF0IGxlYXN0IG9uZSB1cGxvYWRpbmcgcXVldWUuYCk7XG4gICAgfVxuICB9XG59XG4iXX0=